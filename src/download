#!/bin/bash

GNU_MIRROR=http://mirror.inode.at/gnu

function fail()
{
  msg=$1
  echo $msg >&2
  exit 1
}

function patch_package()
{
  name=$1
  if [ -f patches/$name.patch ]; then
    echo "Patching $name"
    pushd $name && patch -p0 < ../patches/$name.patch && popd || fail "Failed to patch $name"
  fi
}

function download()
{
  name=$1
  file=$2
  url=$3
  if [ -d $name ]; then
    return 0
  fi
  mkdir -p .downloads
  if [ ! -f .downloads/$file ]; then
    pushd .downloads && wget $url && popd || fail "Failed to get $name"
  fi
  tar xf .downloads/$file && mv $name-* $name || mv "$name"_* $name || fail "Failed to unpack $name"
  patch_package $name
}

function url_download() 
{
  name=$1
  url=$2
  file=`basename $url`
  download $name $file $url
} 

function gnu_download() 
{
  name=$1
  version=$2
  ext=$3
  canonical=$4
  file=$name-$version.$ext
  if [ "X$canonical" = "X" ]; then
    url=$GNU_MIRROR/$name/$file
  else
    url=$GNU_MIRROR/$name/$canonical/$file
  fi
  download $name $file $url
} 
  
gnu_download gmp 6.1.0 tar.xz
gnu_download mpfr 3.1.4 tar.xz 
gnu_download mpc 1.0.3 tar.gz 
gnu_download gcc 6.1.0 tar.gz gcc-6.1.0
gnu_download libtool 2.4.6 tar.xz 
gnu_download libunistring 0.9.6 tar.xz
url_download libatomic_ops http://www.ivmaisoft.com/_bin/atomic_ops/libatomic_ops-7.4.2.tar.gz
url_download gc http://www.hboehm.info/gc/gc_source/gc-7.4.2.tar.gz
gnu_download guile 2.0.9 tar.xz
gnu_download autogen 5.18.9 tar.xz rel5.18.9
gnu_download autoconf 2.69 tar.xz 
gnu_download automake 1.15 tar.xz

url_download zlib http://zlib.net/zlib-1.2.8.tar.gz
url_download bzip2 http://bzip.org/1.0.6/bzip2-1.0.6.tar.gz
url_download libffi ftp://sourceware.org/pub/libffi/libffi-3.2.1.tar.gz
url_download pcre ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.38.tar.gz
url_download expat http://prdownloads.sourceforge.net/expat/expat-2.1.1.tar.bz2
url_download libpng http://prdownloads.sourceforge.net/libpng/libpng-1.6.22.tar.xz
url_download icu http://download.icu-project.org/files/icu4c/57.1/icu4c-57_1-src.tgz
url_download json-c https://s3.amazonaws.com/json-c_releases/releases/json-c-0.12.1.tar.gz
url_download OpenBLAS http://github.com/xianyi/OpenBLAS/archive/v0.2.18.tar.gz
url_download fam ftp://oss.sgi.com/projects/fam/download/stable/fam-2.7.0.tar.gz 
chmod -R u+w fam
url_download openssl https://www.openssl.org/source/openssl-1.0.2h.tar.gz
url_download Python https://www.python.org/ftp/python/3.5.1/Python-3.5.1.tar.xz
url_download xz http://tukaani.org/xz/xz-5.2.2.tar.xz
url_download libxml2 ftp://xmlsoft.org/libxml2/libxml2-2.9.4.tar.gz
url_download libxslt ftp://xmlsoft.org/libxml2/libxslt-1.1.29.tar.gz
url_download openmpi https://www.open-mpi.org/software/ompi/v1.10/downloads/openmpi-1.10.2.tar.bz2
url_download boost http://prdownloads.sourceforge.net/boost/boost_1_61_0.tar.bz2  
if [ -d boost_1_61_0 ]; then mv boost_* boost; fi
